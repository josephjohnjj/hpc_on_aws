# ---------------------------------------------------------
# Play 11: Install multiple API packages via Spack on controller node
# ---------------------------------------------------------
- name: Install multiple API packages using Spack on controller node
  hosts: control
  become: yes
  gather_facts: yes

  environment:
    SPACK_ROOT: /apps/spack
    PATH: "/apps/spack/bin:{{ ansible_env.PATH }}"
    BASH_ENV: /apps/spack/share/spack/setup-env.sh

  vars:
    spack_api_packages:
      - "openmp@4.0.0 "
      - "python@3.11.0"

  tasks:
    - name: List available Spack packages (spack list)
      shell: . /apps/spack/share/spack/setup-env.sh && spack list
      register: spack_list
      changed_when: false

    - name: Detect installed compilers (spack compiler find)
      shell: . /apps/spack/share/spack/setup-env.sh && spack compiler find
      register: compiler_find
      changed_when: false

    - name: List recognized compilers (spack compilers)
      shell: . /apps/spack/share/spack/setup-env.sh && spack compilers
      register: compiler_list
      changed_when: false

    - name: Output recognized compilers
      debug:
        var: compiler_list.stdout_lines

    - name: Install API packages
      shell: . /apps/spack/share/spack/setup-env.sh && spack install {{ item }}
      args:
        chdir: /apps/spack
      register: spack_install
      retries: 3
      delay: 30
      until: spack_install.rc == 0
      loop: "{{ spack_api_packages }}"

    - name: List installed Spack packages (spack find)
      shell: . /apps/spack/share/spack/setup-env.sh && spack find
      register: spack_find
      changed_when: false

    - name: Output installed Spack packages
      debug:
        var: spack_find.stdout_lines

    - name: Load API packages environment
      shell: |
        . /apps/spack/share/spack/setup-env.sh
        {% for pkg in spack_api_packages %}
        spack load {{ pkg }}
        {% endfor %}
      changed_when: false
