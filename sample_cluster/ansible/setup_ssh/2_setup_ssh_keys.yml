- name: Setup inter-instance SSH keys for all hosts
  hosts: all
  become: yes
  gather_facts: no

  vars:
    ssh_key_path: "/home/{{ ansible_user }}/.ssh/id_rsa"

  tasks:
    - name: Delete keys directory if it exists (on control node)
      file:
        path: "./keys"
        state: absent
      delegate_to: localhost
      become: false

    - name: Recreate empty keys directory (on control node)
      file:
        path: "./keys"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: false

    - name: Ensure .ssh directory exists
      file:
        path: "/home/{{ ansible_user }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Generate SSH key pair (if not present)
      openssh_keypair:
        path: "{{ ssh_key_path }}"
        type: rsa
        size: 4096
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: Read public key
      slurp:
        src: "{{ ssh_key_path }}.pub"
      register: pubkey

    - name: Save public key locally
      delegate_to: localhost
      become: no
      copy:
        content: "{{ pubkey.content | b64decode }}"
        dest: "./keys/{{ inventory_hostname }}.pub"
