# ---------------------------------------------------------
# Enable SSH Password Authentication for All Users
# ---------------------------------------------------------

- name: Enable SSH password authentication for all users and reboot system
  hosts: ec2
  become: yes
  gather_facts: yes

  tasks:
    # --- Disable conflicting cloud-init config ---
    - name: Disable cloud-initâ€™s default SSH config that blocks password auth
      command: mv /etc/ssh/sshd_config.d/60-cloudimg-settings.conf /etc/ssh/sshd_config.d/60-cloudimg-settings.conf.disabled
      args:
        removes: /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
      notify: Restart sshd

    # --- Core sshd_config settings ---
    - name: Ensure PasswordAuthentication is enabled in sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication yes"
        state: present
        backrefs: yes
      notify: Restart sshd

    - name: Ensure ChallengeResponseAuthentication is disabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?ChallengeResponseAuthentication"
        line: "ChallengeResponseAuthentication no"
        state: present
        backrefs: yes
      notify: Restart sshd

    - name: Ensure PAM is enabled for sshd
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?UsePAM"
        line: "UsePAM yes"
        state: present
        backrefs: yes
      notify: Restart sshd

    # --- Cloud-init override ---
    - name: Ensure cloud-init allows SSH password authentication
      lineinfile:
        path: /etc/cloud/cloud.cfg
        regexp: "^ssh_pwauth:"
        line: "ssh_pwauth:   1"
        create: yes

    # --- Explicit override config ---
    - name: Ensure SSH password authentication override is enabled
      copy:
        dest: /etc/ssh/sshd_config.d/99-password.conf
        content: |
          PasswordAuthentication yes
      notify: Restart sshd

    # --- Reboot to apply everything ---
    - name: Reboot the server to apply all changes
      reboot:
        reboot_timeout: 300

  handlers:
    - name: Restart sshd
      service:
        name: sshd
        state: restarted
