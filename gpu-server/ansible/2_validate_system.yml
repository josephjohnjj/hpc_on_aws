---
# ---------------------------------------------------------
# Validate EC2 System Requirements
# ---------------------------------------------------------
- name: Validate system requirements
  hosts: ec2
  become: yes
  gather_facts: yes

  tasks:
    # Ensure the operating system is Ubuntu 22.04
    - name: Check OS is Ubuntu 22.04
      fail:
        msg: "This playbook only supports Ubuntu 22.04"
      when: not (ansible_distribution == "Ubuntu" and ansible_distribution_version == "22.04")

    # Check if the CPU vendor is Intel
    - name: Check CPU is Intel
      assert:
        that:
          - "'GenuineIntel' in ansible_processor"
        fail_msg: "This host is not using an Intel CPU"

    # Ensure that an NVIDIA GPU is available
    - name: Check NVIDIA GPU is present
      shell: lspci | grep -i nvidia
      register: nvidia_gpu_check
      changed_when: false
      failed_when: nvidia_gpu_check.rc != 0

    # Set a custom fact if all requirements are met
    - name: Set system check fact
      set_fact:
        requirements_met: true

    # Abort remaining tasks if any requirement is not met
    - name: End play if requirements are not satisfied
      meta: end_play
      when: requirements_met is not defined or not requirements_met
