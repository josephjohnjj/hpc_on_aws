# ---------------------------------------------------------
# Play 8: Setup spackadmin Group and Secure /apps Access
# ---------------------------------------------------------
- name: Setup spackadmin group and users with sudo and /apps permissions
  hosts: ec2
  become: yes
  gather_facts: yes

  vars:
    spack_group: spackadmin
    spack_user: spackuser
    spack_dir: /apps
    user_password: "nci@Kambri"  # password for spackuser
    current_user: "{{ ansible_env.USER }}"

  tasks:
    # Create an admin group
    - name: Create group "{{ spack_group }}"
      group:
        name: "{{ spack_group }}"
        state: present

    # Create the main Spack user and add to group
    - name: Create user "{{ spack_user }}" with password and add to "{{ spack_group }}"
      user:
        name: "{{ spack_user }}"
        groups: "{{ spack_group }}"
        append: yes
        password: "{{ user_password | password_hash('sha512') }}"
        shell: /bin/bash
        create_home: yes
        state: present

    # Add current Ansible user to the same group for collaboration
    - name: Add current user "{{ current_user }}" to "{{ spack_group }}"
      user:
        name: "{{ current_user }}"
        groups: "{{ spack_group }}"
        append: yes

    # Allow group members sudo access with no password prompt
    - name: Give "{{ spack_group }}" sudo privileges without password
      copy:
        dest: "/etc/sudoers.d/{{ spack_group }}"
        content: "{{ spack_group }} ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: '0440'

    # Change ownership of /apps so that group controls it
    - name: Change ownership of "{{ spack_dir }}" to root:"{{ spack_group }}"
      file:
        path: "{{ spack_dir }}"
        state: directory
        recurse: yes
        owner: root
        group: "{{ spack_group }}"

    # Give group read/write/execute access
    - name: Set group read/write/execute permissions on "{{ spack_dir }}"
      file:
        path: "{{ spack_dir }}"
        recurse: yes
        mode: "g+rwX"

    # Set the setgid bit so new subdirectories inherit the group
    - name: Set setgid bit on directories inside "{{ spack_dir }}"
      command: find "{{ spack_dir }}" -type d -exec chmod g+s {} \;

    # Ensure sticky group ownership applies to top-level dir too
    - name: Ensure group sticky bit set on "{{ spack_dir }}"
      file:
        path: "{{ spack_dir }}"
        mode: "g+s"

    # Allow other users to read/execute content (e.g., students)
    - name: Set others read and execute permissions on "{{ spack_dir }}"
      file:
        path: "{{ spack_dir }}"
        recurse: yes
        mode: "o=rx"


# ---------------------------------------------------------
# Play 9: Create 30 Users and Assign to cudauser Group
# ---------------------------------------------------------
- name: Create CUDA user group and 30 users
  hosts: ec2
  become: yes
  gather_facts: no
  vars:
    user_count: 40
    default_password: "nciuser"  # Password for all 30 users
    user_prefix: "user"          # Users will be named user1, user2, ...

  tasks:
    # Create a dedicated group for CUDA users
    - name: Create supergroup 'cudauser'
      group:
        name: cudauser
        state: present
      when:
        - ansible_distribution == "Ubuntu"
        - ansible_distribution_version == "22.04"

    # Create users user1 to user30 and add them to the cudauser group
    - name: Create 30 users and add to cudauser group
      user:
        name: "{{ user_prefix }}{{ item }}"
        groups: cudauser
        append: yes
        password: "{{ default_password | password_hash('sha512') }}"
        shell: /bin/bash
        state: present
      loop: "{{ query('sequence', 'start=1 end=' + user_count|string) }}"
      when:
        - ansible_distribution == "Ubuntu"
        - ansible_distribution_version == "22.04"
