---
- name: Setup passwordless SSH between EC2 nodes
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    target_user: rocky
    ssh_dir: "/home/{{ target_user }}/.ssh"

  tasks:
    - name: Ensure .ssh directory exists
      file:
        path: "{{ ssh_dir }}"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0700'
      tags:
        - ssh
        - setup
        - directories

    - name: Ensure known_hosts file exists
      file:
        path: "{{ ssh_dir }}/known_hosts"
        state: touch
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'
      tags:
        - ssh
        - setup
        - known_hosts

    - name: Read all public keys from local keys directory
      delegate_to: localhost
      become: false
      find:
        paths: "./keys"
        patterns: "*.pub"
      register: pubkey_files
      tags:
        - ssh
        - keys
        - read

    - name: Append each public key to authorized_keys on remote hosts
      authorized_key:
        user: "{{ target_user }}"
        key: "{{ lookup('file', item.path) }}"
        state: present
      loop: "{{ pubkey_files.files }}"
      tags:
        - ssh
        - keys
        - authorized_keys

    - name: Gather all EC2 private IPs
      set_fact:
        all_private_ips: "{{ groups['all'] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | list }}"
      tags:
        - ssh
        - ips
        - facts

    - name: Compute other nodes' private IPs for this host
      set_fact:
        other_private_ips: "{{ all_private_ips | difference([ansible_default_ipv4.address]) }}"
      tags:
        - ssh
        - ips
        - facts

    - name: Remove stale known_hosts entries for private IPs
      known_hosts:
        path: "{{ ssh_dir }}/known_hosts"
        name: "{{ item }}"
        state: absent
      loop: "{{ other_private_ips }}"
      become_user: "{{ target_user }}"
      tags:
        - ssh
        - known_hosts
        - cleanup

    - name: Add other nodes' SSH host keys to known_hosts
      become_user: "{{ target_user }}"
      shell: |
        ssh-keyscan -T 5 -H {{ item }} 2>/dev/null >> {{ ssh_dir }}/known_hosts
      args:
        executable: /bin/bash
      loop: "{{ other_private_ips }}"
      register: sshscan_output
      failed_when: sshscan_output.rc != 0 and sshscan_output.stdout == ""
      tags:
        - ssh
        - known_hosts
        - scan

    - name: Configure SSH client to avoid host key confirmation
      copy:
        dest: "{{ ssh_dir }}/config"
        content: |
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile {{ ssh_dir }}/known_hosts
            LogLevel ERROR
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0600'
      tags:
        - ssh
        - client
        - config

    - name: Test SSH connection to other nodes
      become_user: "{{ target_user }}"
      shell: ssh -o BatchMode=yes -o ConnectTimeout=3 {{ target_user }}@{{ item }} "echo Connected to $(hostname)"
      loop: "{{ other_private_ips }}"
      register: ssh_test
      ignore_errors: true
      tags:
        - ssh
        - test
        - connectivity

    - name: Show SSH test results
      debug:
        var: ssh_test.results
      tags:
        - ssh
        - test
        - debug
