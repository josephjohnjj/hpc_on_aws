---
- name: Build and install OpenPBS on all nodes
  hosts: all
  become: yes
  vars:
    pbs_repo: "https://github.com/openpbs/openpbs.git"
    pbs_prefix: "/opt/pbs"
    pbs_src_dir: "/tmp/openpbs"

  tasks:
    - name: Ensure git is installed
      ansible.builtin.dnf:
        name: git
        state: present
      tags: git

    - name: Clone OpenPBS repository
      ansible.builtin.git:
        repo: "{{ pbs_repo }}"
        dest: "{{ pbs_src_dir }}"
        version: master
        force: yes
      tags: git

    - name: Run autogen.sh
      ansible.builtin.command: ./autogen.sh
      args:
        chdir: "{{ pbs_src_dir }}"
      tags: configure

    - name: Configure OpenPBS
      ansible.builtin.command: ./configure --prefix={{ pbs_prefix }}
      args:
        chdir: "{{ pbs_src_dir }}"
      tags: configure

    - name: Build OpenPBS using all CPU cores
      ansible.builtin.shell: make -j"$(nproc)"
      args:
        chdir: "{{ pbs_src_dir }}"
        executable: /bin/bash
      tags: make

    - name: Install OpenPBS
      ansible.builtin.shell: make install
      args:
        chdir: "{{ pbs_src_dir }}"
        executable: /bin/bash
      tags: make

    - name: Create PBS environment file
      ansible.builtin.copy:
        dest: /etc/profile.d/pbs.sh
        content: |
          export PATH={{ pbs_prefix }}/bin:{{ pbs_prefix }}/sbin:$PATH
        owner: root
        group: root
        mode: "0644"
      tags: pbs_env

    - name: Source PBS environment for current session
      ansible.builtin.shell: source /etc/profile.d/pbs.sh
      args:
        executable: /bin/bash
      tags: pbs_env
